<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Running retro-contest baselines</title>
  <meta name="description" content=" ">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="rivesunder.github.io/20180507RetroContestBaselines/">
  <link rel="alternate" type="application/rss+xml" title="The Sunder blog" href="rivesunder.github.io/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">The Sunder blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Running retro-contest baselines</h1>
    <p class="post-meta"><time datetime="2018-05-07T00:38:32+01:00" itemprop="datePublished">May 7, 2018</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><img src="/imgs/basslines.png" alt="alt text" title="...sorry"> </p>

<p><em>Getting started described in a previous <a href="https://rivesunder.github.io/retro-contest/2018/04/19/intro-to-retro-contest.html">post.</a></em></p>

<p>In this post we&#39;ll take a look at the baseline agents built by OpenAI for completing the &quot;Gotta Learn Fast&quot; transfer learning benchmark based on Sonic the Hedgehog&trade;. OpenAI baseline agents consist of JERK, a memorization bot; PPO, a policy gradient method; and Rainbow, a combination of improvements built on the deep Q learning used by Deepmind in their 2015 foray into atari mastery.</p>

<p>The <a href="https://github.com/openai/retro-baselines">retro-baselines repository</a> contains an agents folder with both the agents and corresponding dockerfiles for building a container for each agent. Clone the repository </p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone https://github.com/openai/retro-baselines</code></pre></figure>

<h1 id="just-enough-retained-knowledge">Just Enough Retained Knowledge</h1>

<p>cd into the agents directory so we can build a docker container for JERK.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># define registry if you haven't added this line to ~/.bashrc</span>
<span class="nb">export </span><span class="nv">DOCKER_REGISTRY</span><span class="o">=</span><span class="s2">"retrocontestlcabrnqjsuhzeptw.azurecr.io"</span>
<span class="c"># build container for JERK</span>
docker build -f jerk.docker -t <span class="nv">$DOCKER_REGISTRY</span>/jerk-agent:v1 .</code></pre></figure>

<p>One problem OpenAI is attempting to address with the Sonic benchmark and contest is poor separation of training and test sets in RL game-playing. Therefore we want to run our agent on a training/test split, and I&#39;ll use the same list of <a href="https://github.com/riveSunder/sonicBots/blob/master/data/sonic-test.csv">test</a> (and <a href="https://github.com/riveSunder/sonicBots/blob/master/data/sonic-train.csv">training</a>) levels reported in OpenAI&#39;s <a href="https://s3-us-west-2.amazonaws.com/openai-assets/research-covers/retro-contest/gotta_learn_fast_report.pdf">technical report.</a> But JERK doesn&#39;t use any observations of the environment, so we can just run the bot on the test set, so we can just run it. To do so, I wrote a <a href="">wrapper</a> that runs through the list of gamestates for the test set and runs JERK for 20 minutes of wall-time (impatience) and saves the results for each test level in a separate folder. My results on the test set: </p>

<p><br></p>

<table><thead>
<tr>
<th>gamestate</th>
<th style="text-align: center">score</th>
<th style="text-align: right">std dev.</th>
</tr>
</thead><tbody>
<tr>
<td>SonicAndKnuckles3-GenesisFlyingBatteryZone.Act2</td>
<td style="text-align: center">1253.13</td>
<td style="text-align: right">143.98</td>
</tr>
<tr>
<td>SonicAndKnuckles3-GenesisLavaReefZone.Act1</td>
<td style="text-align: center">126.72</td>
<td style="text-align: right">239.68</td>
</tr>
<tr>
<td>SonicTheHedgehog2-GenesisHillTopZone.Act2</td>
<td style="text-align: center">1385.38</td>
<td style="text-align: right">571.86</td>
</tr>
<tr>
<td>SonicAndKnuckles3-GenesisHydrocityZone.Act1</td>
<td style="text-align: center">2140.97</td>
<td style="text-align: right">1226.02</td>
</tr>
<tr>
<td>SonicTheHedgehog2-GenesisCasinoNightZone.Act2</td>
<td style="text-align: center">1663.08</td>
<td style="text-align: right">1638.69</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisSpringYardZone.Act1</td>
<td style="text-align: center">825.07</td>
<td style="text-align: right">693.82</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisGreenHillZone.Act2</td>
<td style="text-align: center">2327.98</td>
<td style="text-align: right">1982.28</td>
</tr>
<tr>
<td>SonicAndKnuckles3-GenesisAngelIslandZone.Act2</td>
<td style="text-align: center">806.91</td>
<td style="text-align: right">564.96</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisScrapBrainZone.Act1</td>
<td style="text-align: center">1017.33</td>
<td style="text-align: right">629.57</td>
</tr>
<tr>
<td>SonicTheHedgehog2-GenesisMetropolisZone.Act3</td>
<td style="text-align: center">1392.68</td>
<td style="text-align: right">1047.23</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisStarLightZone.Act3</td>
<td style="text-align: center">2369.18</td>
<td style="text-align: right">414.58</td>
</tr>
<tr>
<td>Aggregate</td>
<td style="text-align: center">1391.68</td>
<td style="text-align: right">666.73</td>
</tr>
</tbody></table>

<p><br></p>

<p>These are lower than the scores reported in the technical report-I didn&#39;t feed the JERK much compute, limiting it to 20 minutes per test level.</p>

<p>Digging into the <code>jerk_agent.py</code> code (and the algorithm description in the technical report) gives us a good idea of the <em>modus gofastus</em> of the JERK approach. The bot will split its time according to a exploitation rate variable, hopefully finding a balance between reliving the glory days of its best run so far and exploring new things. The exploration strategy consists of running right for some number of steps while hopping with some probability, and the agent backtracks if it gets a negative reward trying to run right. So JERK, which stands for &quot;Just Enough Retained Knowledge,&quot; is a memorization bot with quite a few parameters (exploitation rate, jump probability, etc.) that can be painstakingly manually adjusted to slightly boost or totally destroy its performance.</p>

<h1 id="proximal-policy-optimization">Proximal Policy Optimization</h1>

<p>To run the ppo2 agent from the <code>retro-baselines</code>, you&#39;ll need to get the classic gym baselines from OpenAI on Github. </p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone http://github.com/openai/baselines
<span class="nb">cd </span>baselines
pip install -e . </code></pre></figure>
 

<p>I forked both the retro-baselines and the baselines repository from OpenAI so that I could keep track of changes I made while working with them on Github as well as locally. I suggest you do the same: forking is a good way to give credit to a repository&#39;s creator. Not to mention if you really get into it and fix a few bugs or come up with a significant addition you can later do a pull request for your work to be considered as an addition to the main branch. You can build a docker container using the <a href="https://github.com/openai/retro-baselines/blob/master/agents/ppo2.docker">ppo2.docker file</a> included in the retro-baselines repository. The ppo2 .docker file is more involved than the JERK .docker file and if, like me, you&#39;re relatively new to rolling your own docker containers it&#39;s a good idea to go through it to figure out what each part is up to and spend some time with <a href="https://docs.docker.com/develop/develop-images/baseimages/#create-a-simple-parent-image-using-scratch">the</a> <a href="https://docs.docker.com/engine/reference/builder/">relevant</a> <a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">documentation</a>. Once you&#39;re ready use cd into the agents directory and use <code>docker build</code> as before to build the ppo2 container. </p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker build -f ppo2.docker -t <span class="nv">$DOCKER_REGISTRY</span>/ppo2-agent:v1 .</code></pre></figure>

<p>Running through the </p>

<table><thead>
<tr>
<th>gamestate</th>
<th style="text-align: center">score</th>
<th style="text-align: right">std dev</th>
</tr>
</thead><tbody>
<tr>
<td>SonicAndKnuckles3-GenesisFlyingBatteryZone.Act2</td>
<td style="text-align: center">647.67</td>
<td style="text-align: right">70.38</td>
</tr>
<tr>
<td>SonicAndKnuckles3-GenesisLavaReefZone.Act1</td>
<td style="text-align: center">1208.99</td>
<td style="text-align: right">1438.33</td>
</tr>
<tr>
<td>SonicTheHedgehog2-GenesisHillTopZone.Act2</td>
<td style="text-align: center">383.38</td>
<td style="text-align: right">524.76</td>
</tr>
<tr>
<td>SonicAndKnuckles3-GenesisHydrocityZone.Act1</td>
<td style="text-align: center">780.49</td>
<td style="text-align: right">0.00</td>
</tr>
<tr>
<td>SonicTheHedgehog2-GenesisCasinoNightZone.Act2</td>
<td style="text-align: center">1286.41</td>
<td style="text-align: right">995.79</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisSpringYardZone.Act1</td>
<td style="text-align: center">377.86</td>
<td style="text-align: right">169.72</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisGreenHillZone.Act2</td>
<td style="text-align: center">2410.49</td>
<td style="text-align: right">392.95</td>
</tr>
<tr>
<td>SonicAndKnuckles3-GenesisAngelIslandZone.Act2</td>
<td style="text-align: center">1634.78</td>
<td style="text-align: right">663.77</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisScrapBrainZone.Act1</td>
<td style="text-align: center">706.98</td>
<td style="text-align: right">356.16</td>
</tr>
<tr>
<td>SonicTheHedgehog2-GenesisMetropolisZone.Act3</td>
<td style="text-align: center">816.51</td>
<td style="text-align: right">507.60</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisStarLightZone.Act3</td>
<td style="text-align: center">2221.11</td>
<td style="text-align: right">788.97</td>
</tr>
<tr>
<td>Aggregate</td>
<td style="text-align: center">1134.06</td>
<td style="text-align: right">665.42</td>
</tr>
</tbody></table>

<p><br></p>

<h1 id="a-rainbow-of-improvements-to-deep-q-learning">A Rainbow of Improvements to Deep Q-learning</h1>

<p>Rainbow is a <a href="https://arxiv.org/abs/1710.02298">combination</a> of different tweaks on DQN which together performed better than the original &quot;human-level&quot; DQN. To play around with Rainbow you&#39;ll need to <code>pip install anyrl</code> from <a href="https://github.com/unixpickle/anyrl-py/tree/master/anyrl">unixpickle</a> (or clone/fork the repository as for baselines and retro-baselines earlier).  </p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker build -f rainbow.docker -t <span class="nv">$DOCKER_REGISTRY</span>/rainbow-agent:v1 .</code></pre></figure>
 

<p>Rainbow results on the validation levels:</p>

<table><thead>
<tr>
<th>gamestate</th>
<th style="text-align: center">score</th>
<th style="text-align: right">std dev</th>
</tr>
</thead><tbody>
<tr>
<td>SonicAndKnuckles3-GenesisFlyingBatteryZone.Act2</td>
<td style="text-align: center">212.03</td>
<td style="text-align: right">79.87</td>
</tr>
<tr>
<td>SonicAndKnuckles3-GenesisLavaReefZone.Act1</td>
<td style="text-align: center">32.95</td>
<td style="text-align: right">0.00</td>
</tr>
<tr>
<td>SonicTheHedgehog2-GenesisHillTopZone.Act2</td>
<td style="text-align: center">2.53</td>
<td style="text-align: right">11.94</td>
</tr>
<tr>
<td>SonicAndKnuckles3-GenesisHydrocityZone.Act1</td>
<td style="text-align: center">780.49</td>
<td style="text-align: right">0.00</td>
</tr>
<tr>
<td>SonicTheHedgehog2-GenesisCasinoNightZone.Act2</td>
<td style="text-align: center">266.96</td>
<td style="text-align: right">0.00</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisSpringYardZone.Act1</td>
<td style="text-align: center">195.13</td>
<td style="text-align: right">32.39</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisGreenHillZone.Act2</td>
<td style="text-align: center">4.41</td>
<td style="text-align: right">20.81</td>
</tr>
<tr>
<td>SonicAndKnuckles3-GenesisAngelIslandZone.Act2</td>
<td style="text-align: center">635.29</td>
<td style="text-align: right">521.91</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisScrapBrainZone.Act1</td>
<td style="text-align: center">536.17</td>
<td style="text-align: right">103.36</td>
</tr>
<tr>
<td>SonicTheHedgehog2-GenesisMetropolisZone.Act3</td>
<td style="text-align: center">295.91</td>
<td style="text-align: right">2.12</td>
</tr>
<tr>
<td>SonicTheHedgehog-GenesisStarLightZone.Act3</td>
<td style="text-align: center">1084.55</td>
<td style="text-align: right">1139.19</td>
</tr>
<tr>
<td>Aggregate</td>
<td style="text-align: center">367.86</td>
<td style="text-align: right">334.52</td>
</tr>
</tbody></table>

<p><br></p>

<p>As expected, ppo2 and rainbow don&#39;t learn particularly quickly with only 20 minutes wall time on a laptop (intel i5 2.40GHz × 4). Playing from scratch on OpenAI&#39;s secret test levels, JERK, ppo2, and rainbow scored 3711.44, 3377.74, and 3443.59, respectively. There&#39;s obviously plenty of room for improvement, and it will be interested to see how prior learning on the training levels might yield some better scores. I&#39;ve also been trying (so far unsuccessfully) to build a wrapper for the Actor-Critic with Experience  Replay (<a href="https://arxiv.org/abs/1611.01224">Wang et al 2016</a> on Arxiv) <a href="https://github.com/openai/baselines/tree/master/baselines/acer">implementation</a> from openai/baselines, but I&#39;m having trouble with the gym remote environment interface. </p>

<p>In my next entry I hope to showcase some actual, ahem, transfer learning with one of the baseline agents, as well as making better progress on implementing an agent not demonstrated in the technical report. </p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">The Sunder blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>The Sunder blog</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/riveSunder"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">riveSunder</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
